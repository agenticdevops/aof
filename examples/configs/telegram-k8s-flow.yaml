# Telegram K8s Bot AgentFlow Example
#
# This example shows how to set up a Telegram bot that routes messages
# to different agents based on patterns, following the same architecture
# as the Slack bot.
#
# Usage:
#   1. Create the agent: agents/k8s-ops.yaml
#   2. Create this flow: flows/telegram-k8s-flow.yaml
#   3. Start the server:
#      aofctl serve --config examples/configs/telegram-bot.yaml \
#                   --agents-dir ./agents \
#                   --flows-dir ./flows
#
# Environment Variables:
#   - TELEGRAM_BOT_TOKEN: Bot token from @BotFather
#   - GOOGLE_API_KEY: Google AI API key for Gemini model

apiVersion: aof.dev/v1
kind: AgentFlow
metadata:
  name: telegram-k8s-bot-flow
  labels:
    platform: telegram
    category: infrastructure
    environment: production

spec:
  # Telegram trigger configuration
  trigger:
    type: Telegram
    config:
      bot_token: ${TELEGRAM_BOT_TOKEN}
      # Optional: Restrict to specific chat IDs
      # chat_ids: [-1001234567890, -1009876543210]
      # Optional: Restrict to specific usernames
      # allowed_users: ["admin_user", "sre_lead"]
      events:
        - message
        - callback_query  # For inline button responses

  # Execution context (environment variables available to agents)
  context:
    kubeconfig: ${KUBECONFIG}
    namespace: ${NAMESPACE:-default}
    cluster_name: ${CLUSTER_NAME:-default}
    env:
      REQUIRE_APPROVAL: "true"
      APPROVAL_TIMEOUT: "300"

  # Agent routing - which agent handles which patterns
  agents:
    - name: k8s-ops
      patterns:
        - "kubectl"
        - "k8s"
        - "pod"
        - "deploy"
        - "scale"
        - "namespace"
        - "service"
        - "ingress"
      description: "Kubernetes operations agent"

    - name: incident-responder
      patterns:
        - "incident"
        - "outage"
        - "alert"
        - "error"
        - "crash"
      description: "Incident response agent"

    - name: general-assistant
      patterns: []  # Catch-all for unmatched messages
      description: "General purpose assistant"

  # Approval workflow for destructive commands
  approval:
    enabled: true
    # Telegram user IDs who can approve (use /myid to get your ID)
    allowed_users:
      - "123456789"   # Admin user
      - "987654321"   # SRE lead
    # Commands that require approval
    require_for:
      - "kubectl delete"
      - "kubectl scale --replicas=0"
      - "helm uninstall"
      - "kubectl drain"

  # Node definitions (optional - for complex workflows)
  nodes:
    - id: parse-message
      type: Transform
      config:
        script: |
          export MESSAGE_TEXT="${event.text}"
          export CHAT_ID="${event.chat_id}"
          export USER_ID="${event.user_id}"

    - id: agent-process
      type: Agent
      config:
        # Agent selection is automatic based on patterns above
        input: ${MESSAGE_TEXT}

    - id: send-response
      type: Telegram
      config:
        chat_id: ${CHAT_ID}
        message: ${agent-process.output}
        parse_mode: Markdown

  # Flow connections
  connections:
    - from: trigger
      to: parse-message
    - from: parse-message
      to: agent-process
    - from: agent-process
      to: send-response
