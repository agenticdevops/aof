apiVersion: aof.sh/v1alpha1
kind: AgentFlow
metadata:
  name: pr-review-flow
  description: Automated PR review for security, performance, and best practices

triggers:
  - platform: github
    events:
      - pull_request.opened
      - pull_request.synchronize

input:
  from_event:
    pr_number: "\{\{ event.pull_request.number \}\}"
    repo: "\{\{ event.repository.full_name \}\}"
    head_sha: "\{\{ event.pull_request.head.sha \}\}"
    base_branch: "\{\{ event.pull_request.base.ref \}\}"
    author: "\{\{ event.pull_request.user.login \}\}"
    files_changed: "\{\{ event.pull_request.changed_files \}\}"

# Skip if PR is from bot or draft
conditions:
  - "\{\{ not event.pull_request.draft \}\}"
  - "\{\{ event.pull_request.user.type != 'Bot' \}\}"

steps:
  # Create initial check run
  - name: create-check
    agent: github
    action: create_check_run
    input:
      repo: "\{\{ input.repo \}\}"
      head_sha: "\{\{ input.head_sha \}\}"
      name: "AOF Code Review"
      status: "in_progress"
      output:
        title: "Reviewing PR..."
        summary: "Automated code review in progress"

  # Get changed files
  - name: get-files
    agent: github
    action: get_pr_files
    input:
      repo: "\{\{ input.repo \}\}"
      pr_number: "\{\{ input.pr_number \}\}"

  # Parallel analysis
  - name: analyze
    parallel: true
    steps:
      # Security scan
      - name: security-scan
        agent: security-scanner
        action: scan
        input:
          repo: "\{\{ input.repo \}\}"
          ref: "\{\{ input.head_sha \}\}"
          files: "\{\{ steps.get-files.output.files \}\}"
        checks:
          - type: secrets
            severity: critical
          - type: sql_injection
            severity: high
          - type: xss
            severity: high
          - type: dependencies
            severity: medium

      # Performance analysis
      - name: perf-analysis
        agent: perf-analyzer
        action: analyze
        input:
          files: "\{\{ steps.get-files.output.files \}\}"
        checks:
          - type: n_plus_one
          - type: missing_indexes
          - type: large_payloads
          - type: inefficient_loops

      # Code quality
      - name: quality-check
        agent: code-quality
        action: check
        input:
          files: "\{\{ steps.get-files.output.files \}\}"
          config:
            max_complexity: 10
            max_file_length: 500
            require_tests: true
            coverage_threshold: 80

      # Kubernetes manifest validation (if applicable)
      - name: k8s-validation
        agent: kubernetes-validator
        condition: "\{\{ steps.get-files.output.files | selectattr('filename', 'match', '.*\\.ya?ml$') | list | length > 0 \}\}"
        action: validate
        input:
          files: "\{\{ steps.get-files.output.files | selectattr('filename', 'match', '.*\\.ya?ml$') | list \}\}"
        checks:
          - type: schema
          - type: security_context
          - type: resource_limits
          - type: best_practices

  # Aggregate results
  - name: aggregate-results
    agent: review-aggregator
    action: aggregate
    input:
      security: "\{\{ steps.analyze.security-scan.output \}\}"
      performance: "\{\{ steps.analyze.perf-analysis.output \}\}"
      quality: "\{\{ steps.analyze.quality-check.output \}\}"
      k8s: "\{\{ steps.analyze.k8s-validation.output | default({}) \}\}"

  # Determine approval status
  - name: determine-status
    agent: decision-maker
    action: evaluate
    input:
      results: "\{\{ steps.aggregate-results.output \}\}"
    rules:
      - condition: "\{\{ results.security.critical_count > 0 \}\}"
        status: "failure"
        message: "Critical security issues found"
      - condition: "\{\{ results.security.high_count > 0 \}\}"
        status: "failure"
        message: "High severity security issues found"
      - condition: "\{\{ results.quality.coverage < 80 \}\}"
        status: "failure"
        message: "Test coverage below 80%"
      - condition: "\{\{ results.performance.issues | length > 5 \}\}"
        status: "warning"
        message: "Multiple performance issues detected"
      - default:
        status: "success"
        message: "All checks passed"

  # Post review comment
  - name: post-review
    agent: github
    action: post_review
    input:
      repo: "\{\{ input.repo \}\}"
      pr_number: "\{\{ input.pr_number \}\}"
      commit_id: "\{\{ input.head_sha \}\}"
      event: "\{\{ 'APPROVE' if steps.determine-status.output.status == 'success' else 'REQUEST_CHANGES' \}\}"
      body: |
        ## ğŸ¤– Automated Code Review

        \{\{ 'âœ…' if steps.determine-status.output.status == 'success' else 'âŒ' \}\} **\{\{ steps.determine-status.output.message \}\}**

        ### Security Scan
        \{\{ 'âœ…' if steps.aggregate-results.output.security.passed else 'âŒ' \}\} \{\{ steps.aggregate-results.output.security.summary \}\}
        {% if steps.aggregate-results.output.security.issues %}
        <details>
        <summary>Security Issues (\{\{ steps.aggregate-results.output.security.issues | length \}\})</summary>

        {% for issue in steps.aggregate-results.output.security.issues %}
        - **\{\{ issue.severity \}\}**: \{\{ issue.message \}\} (`\{\{ issue.file \}\}:\{\{ issue.line \}\}`)
        {% endfor %}
        </details>
        {% endif %}

        ### Performance Analysis
        \{\{ 'âœ…' if steps.aggregate-results.output.performance.passed else 'âš ï¸' \}\} \{\{ steps.aggregate-results.output.performance.summary \}\}
        {% if steps.aggregate-results.output.performance.issues %}
        <details>
        <summary>Performance Issues (\{\{ steps.aggregate-results.output.performance.issues | length \}\})</summary>

        {% for issue in steps.aggregate-results.output.performance.issues %}
        - **\{\{ issue.type \}\}**: \{\{ issue.message \}\} (`\{\{ issue.file \}\}:\{\{ issue.line \}\}`)
        {% endfor %}
        </details>
        {% endif %}

        ### Code Quality
        - Complexity: \{\{ 'âœ…' if steps.aggregate-results.output.quality.complexity_ok else 'âŒ' \}\} (max: \{\{ steps.aggregate-results.output.quality.max_complexity \}\})
        - Test Coverage: \{\{ 'âœ…' if steps.aggregate-results.output.quality.coverage >= 80 else 'âŒ' \}\} \{\{ steps.aggregate-results.output.quality.coverage \}\}%
        - Lint: \{\{ 'âœ…' if steps.aggregate-results.output.quality.lint_passed else 'âŒ' \}\}

        {% if steps.aggregate-results.output.k8s %}
        ### Kubernetes Validation
        \{\{ 'âœ…' if steps.aggregate-results.output.k8s.passed else 'âŒ' \}\} \{\{ steps.aggregate-results.output.k8s.summary \}\}
        {% endif %}

        ---
        <sub>ğŸ¤– Review by [AOF](https://docs.aof.sh) | [Re-run review](\{\{ trigger.event.pull_request.html_url \}\}/checks)</sub>
      comments: "\{\{ steps.aggregate-results.output.inline_comments \}\}"

  # Update check run
  - name: update-check
    agent: github
    action: update_check_run
    input:
      repo: "\{\{ input.repo \}\}"
      check_run_id: "\{\{ steps.create-check.output.id \}\}"
      conclusion: "\{\{ steps.determine-status.output.status \}\}"
      output:
        title: "\{\{ steps.determine-status.output.message \}\}"
        summary: |
          **Security**: \{\{ steps.aggregate-results.output.security.summary \}\}
          **Performance**: \{\{ steps.aggregate-results.output.performance.summary \}\}
          **Quality**: Coverage \{\{ steps.aggregate-results.output.quality.coverage \}\}%

  # Add labels based on content
  - name: add-labels
    agent: github
    action: add_labels
    input:
      repo: "\{\{ input.repo \}\}"
      issue_number: "\{\{ input.pr_number \}\}"
      labels: "\{\{ steps.aggregate-results.output.suggested_labels \}\}"
